# Data Model: Todo Full-Stack Web Application (Phase II)

**Feature**: 002-fullstack-web-app
**Date**: 2026-02-17
**Purpose**: Define database schema, entity relationships, and validation rules

## Overview

This document defines the data model for the multi-user todo web application. The model consists of two primary entities: **User** (for authentication and ownership) and **Task** (for todo items). The relationship is one-to-many: one user owns many tasks.

---

## Entity Relationship Diagram

```
┌─────────────────────┐
│       User          │
├─────────────────────┤
│ id (PK)             │
│ email (UNIQUE)      │
│ hashed_password     │
│ created_at          │
└─────────────────────┘
          │
          │ 1:N
          │
          ▼
┌─────────────────────┐
│       Task          │
├─────────────────────┤
│ id (PK)             │
│ user_id (FK)        │◄─── Foreign Key to User.id
│ title               │
│ description         │
│ completed           │
│ created_at          │
│ updated_at          │
└─────────────────────┘
```

**Relationship**: One User has many Tasks (1:N)
**Cascade**: When a user is deleted, all their tasks are deleted (CASCADE)

---

## Entity: User

**Purpose**: Represents an authenticated user account

### Fields

| Field | Type | Constraints | Description |
|-------|------|-------------|-------------|
| `id` | String (UUID) | PRIMARY KEY, NOT NULL | Unique identifier for the user (generated by Better Auth) |
| `email` | String (255) | UNIQUE, NOT NULL | User's email address (used for signin) |
| `hashed_password` | String (255) | NOT NULL | Bcrypt-hashed password (never store plaintext) |
| `created_at` | DateTime | NOT NULL, DEFAULT NOW() | Timestamp when account was created |

### Validation Rules

**Email**:
- MUST be valid email format (regex: `^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$`)
- MUST be unique across all users
- MUST be lowercase (normalize on input)
- Maximum length: 255 characters

**Password** (before hashing):
- Minimum length: 8 characters
- MUST contain at least one uppercase letter
- MUST contain at least one lowercase letter
- MUST contain at least one digit
- Maximum length: 128 characters (before hashing)

**Hashed Password**:
- MUST be hashed with bcrypt (cost factor 12)
- Stored as 60-character string (bcrypt output)

### Indexes

- **Primary Key**: `id` (automatic)
- **Unique Index**: `email` (for fast lookup during signin)

### State Transitions

Users have no explicit state transitions. Once created, a user account remains active. (Password reset and account deletion are out of scope for Phase II.)

---

## Entity: Task

**Purpose**: Represents a todo item belonging to a specific user

### Fields

| Field | Type | Constraints | Description |
|-------|------|-------------|-------------|
| `id` | Integer | PRIMARY KEY, AUTO_INCREMENT, NOT NULL | Unique identifier for the task |
| `user_id` | String (UUID) | FOREIGN KEY (User.id), NOT NULL, INDEX | Owner of the task |
| `title` | String (200) | NOT NULL | Short description of the task |
| `description` | Text (1000) | NULLABLE | Detailed information about the task |
| `completed` | Boolean | NOT NULL, DEFAULT FALSE | Completion status |
| `created_at` | DateTime | NOT NULL, DEFAULT NOW() | Timestamp when task was created |
| `updated_at` | DateTime | NOT NULL, DEFAULT NOW(), ON UPDATE NOW() | Timestamp when task was last modified |

### Validation Rules

**Title**:
- MUST NOT be empty (after trimming whitespace)
- Minimum length: 1 character (after trimming)
- Maximum length: 200 characters
- Leading/trailing whitespace MUST be trimmed
- Special characters allowed (unicode support)

**Description**:
- OPTIONAL (can be NULL or empty string)
- Maximum length: 1000 characters
- Leading/trailing whitespace MUST be trimmed
- Special characters allowed (unicode support)

**Completed**:
- MUST be boolean (true/false)
- Default value: false (new tasks are incomplete)

**User ID**:
- MUST reference an existing user
- MUST NOT be NULL
- Foreign key constraint enforced at database level

### Indexes

- **Primary Key**: `id` (automatic)
- **Foreign Key Index**: `user_id` (for fast filtering by user)
- **Composite Index**: `(user_id, completed)` (for filtering user's tasks by status)

### State Transitions

Tasks have a simple state machine:

```
┌─────────────┐
│  Incomplete │ ◄──┐
│ (completed: │    │
│   false)    │    │ Toggle
└─────────────┘    │
       │           │
       │ Toggle    │
       │           │
       ▼           │
┌─────────────┐    │
│  Complete   │ ───┘
│ (completed: │
│   true)     │
└─────────────┘
```

**Transitions**:
- `Incomplete → Complete`: User marks task as done
- `Complete → Incomplete`: User marks task as not done (toggle behavior)

---

## Relationships

### User → Task (One-to-Many)

**Cardinality**: One user can have zero or many tasks

**Foreign Key**: `Task.user_id` references `User.id`

**Cascade Behavior**:
- **ON DELETE CASCADE**: When a user is deleted, all their tasks are automatically deleted
- **ON UPDATE CASCADE**: If user.id changes (unlikely with UUID), task.user_id updates automatically

**Enforcement**:
- Database-level foreign key constraint
- Application-level validation (ensure user_id exists before creating task)
- API-level authorization (ensure authenticated user matches task.user_id)

---

## Database Schema (SQL)

### PostgreSQL Schema

```sql
-- Users table (managed by Better Auth, but shown for reference)
CREATE TABLE users (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    email VARCHAR(255) UNIQUE NOT NULL,
    hashed_password VARCHAR(255) NOT NULL,
    created_at TIMESTAMP NOT NULL DEFAULT NOW()
);

-- Create unique index on email for fast lookup
CREATE UNIQUE INDEX idx_users_email ON users(email);

-- Tasks table
CREATE TABLE tasks (
    id SERIAL PRIMARY KEY,
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    title VARCHAR(200) NOT NULL,
    description TEXT,
    completed BOOLEAN NOT NULL DEFAULT FALSE,
    created_at TIMESTAMP NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMP NOT NULL DEFAULT NOW()
);

-- Create index on user_id for fast filtering
CREATE INDEX idx_tasks_user_id ON tasks(user_id);

-- Create composite index for filtering by user and completion status
CREATE INDEX idx_tasks_user_completed ON tasks(user_id, completed);

-- Create trigger to automatically update updated_at
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER update_tasks_updated_at
    BEFORE UPDATE ON tasks
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();
```

---

## SQLModel Implementation

### User Model

```python
from sqlmodel import SQLModel, Field
from datetime import datetime
from typing import Optional
import uuid

class User(SQLModel, table=True):
    """User account for authentication."""

    __tablename__ = "users"

    id: uuid.UUID = Field(
        default_factory=uuid.uuid4,
        primary_key=True,
        nullable=False
    )
    email: str = Field(
        max_length=255,
        unique=True,
        index=True,
        nullable=False
    )
    hashed_password: str = Field(
        max_length=255,
        nullable=False
    )
    created_at: datetime = Field(
        default_factory=datetime.utcnow,
        nullable=False
    )
```

### Task Model

```python
from sqlmodel import SQLModel, Field, Relationship
from datetime import datetime
from typing import Optional
import uuid

class Task(SQLModel, table=True):
    """Todo task belonging to a user."""

    __tablename__ = "tasks"

    id: Optional[int] = Field(
        default=None,
        primary_key=True,
        nullable=False
    )
    user_id: uuid.UUID = Field(
        foreign_key="users.id",
        nullable=False,
        index=True
    )
    title: str = Field(
        max_length=200,
        nullable=False
    )
    description: Optional[str] = Field(
        default=None,
        max_length=1000
    )
    completed: bool = Field(
        default=False,
        nullable=False
    )
    created_at: datetime = Field(
        default_factory=datetime.utcnow,
        nullable=False
    )
    updated_at: datetime = Field(
        default_factory=datetime.utcnow,
        nullable=False
    )
```

---

## Data Validation Layers

### Layer 1: Database Constraints
- NOT NULL constraints
- UNIQUE constraints
- Foreign key constraints
- Check constraints (length limits)

### Layer 2: ORM Validation (SQLModel/Pydantic)
- Field type validation
- Length validation (max_length)
- Required field validation
- Default value assignment

### Layer 3: Application Logic (Services)
- Email format validation
- Password strength validation
- Whitespace trimming
- Business rule validation

### Layer 4: API Validation (FastAPI/Pydantic)
- Request body validation
- Response serialization
- Error message formatting

**Defense in Depth**: Multiple validation layers ensure data integrity even if one layer fails.

---

## Data Access Patterns

### Common Queries

**Get all tasks for a user**:
```sql
SELECT * FROM tasks
WHERE user_id = $1
ORDER BY created_at DESC;
```

**Get incomplete tasks for a user**:
```sql
SELECT * FROM tasks
WHERE user_id = $1 AND completed = FALSE
ORDER BY created_at DESC;
```

**Get completed tasks for a user**:
```sql
SELECT * FROM tasks
WHERE user_id = $1 AND completed = TRUE
ORDER BY created_at DESC;
```

**Get single task (with user verification)**:
```sql
SELECT * FROM tasks
WHERE id = $1 AND user_id = $2;
```

**Update task**:
```sql
UPDATE tasks
SET title = $1, description = $2, updated_at = NOW()
WHERE id = $3 AND user_id = $4;
```

**Toggle task completion**:
```sql
UPDATE tasks
SET completed = NOT completed, updated_at = NOW()
WHERE id = $1 AND user_id = $2;
```

**Delete task**:
```sql
DELETE FROM tasks
WHERE id = $1 AND user_id = $2;
```

**Note**: All queries include `user_id` filter to enforce user isolation.

---

## Migration Strategy

### Initial Migration (Alembic)

**Migration 001: Create users and tasks tables**
- Create users table with constraints
- Create tasks table with foreign key
- Create indexes
- Create updated_at trigger

**Migration 002: Seed data (optional, for development)**
- Create test users
- Create sample tasks

### Future Migrations (Out of Scope for Phase II)
- Add task priorities (Phase III)
- Add task tags/categories (Phase III)
- Add due dates (Phase III)
- Add task attachments (Phase IV)

---

## Performance Considerations

**Indexes**:
- Primary keys (automatic): Fast lookups by ID
- `users.email` (unique): Fast signin lookups
- `tasks.user_id`: Fast filtering by user
- `tasks(user_id, completed)`: Fast filtering by user and status

**Query Optimization**:
- Use connection pooling (SQLAlchemy)
- Use async queries for better concurrency
- Limit result sets (pagination if > 100 tasks)
- Use SELECT only needed columns (avoid SELECT *)

**Scalability**:
- User isolation prevents cross-user queries
- Indexes support efficient filtering
- Serverless database (Neon) auto-scales

---

## Security Considerations

**User Isolation**:
- ALL queries MUST filter by authenticated user_id
- Foreign key constraints prevent orphaned tasks
- API layer verifies user_id matches JWT token

**Password Security**:
- NEVER store plaintext passwords
- Use bcrypt with cost factor 12
- Validate password strength before hashing

**SQL Injection Prevention**:
- Use parameterized queries (SQLModel handles this)
- Never concatenate user input into SQL strings
- ORM provides automatic escaping

---

## Summary

The data model consists of two entities (User and Task) with a one-to-many relationship. The design prioritizes:

- **Simplicity**: Minimal schema for Phase II requirements
- **Security**: User isolation, password hashing, foreign key constraints
- **Performance**: Strategic indexes for common queries
- **Extensibility**: Schema can be extended for Phase III features

**Ready for**: API contract definition and implementation
